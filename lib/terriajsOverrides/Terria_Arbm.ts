// https://arbormeta.earth/#start=%7B%22version%22%3A%228.0.0%22%2C%22initSources%22%3A%5B%7B%22stratum%22%3A%22user%22%2C%22models%22%3A%7B%22ArbormetaData%22%3A%7B%22dereferenced%22%3A%7B%22isOpen%22%3Atrue%7D%2C%22knownContainerUniqueIds%22%3A%5B%22%2F%22%5D%2C%22type%22%3A%22arbm-reference%22%7D%2C%22arbm__kulwin%22%3A%7B%22isOpen%22%3Atrue%2C%22knownContainerUniqueIds%22%3A%5B%22ArbormetaData%22%5D%2C%22type%22%3A%22group%22%7D%2C%22arbm__kulwin__als%22%3A%7B%22knownContainerUniqueIds%22%3A%5B%22arbm__kulwin%22%5D%2C%22type%22%3A%223d-tiles%22%7D%2C%22arbm__kulwin__kulwinmaxar%22%3A%7B%22knownContainerUniqueIds%22%3A%5B%22arbm__kulwin%22%5D%2C%22type%22%3A%22wmts%22%7D%2C%22arbm__kulwin__kuwlinbounds%22%3A%7B%22knownContainerUniqueIds%22%3A%5B%22arbm__kulwin%22%5D%2C%22type%22%3A%22geojson%22%7D%2C%22%2F%22%3A%7B%22type%22%3A%22group%22%7D%7D%2C%22workbench%22%3A%5B%22arbm__kulwin__als%22%2C%22arbm__kulwin__kulwinmaxar%22%2C%22arbm__kulwin__kuwlinbounds%22%5D%2C%22timeline%22%3A%5B%22arbm__kulwin__kuwlinbounds%22%5D%2C%22initialCamera%22%3A%7B%22west%22%3A144.77643288695202%2C%22south%22%3A-32.14870585269829%2C%22east%22%3A144.95549073221088%2C%22north%22%3A-32.090800402872866%2C%22position%22%3A%7B%22x%22%3A-4421310.157908867%2C%22y%22%3A3111274.4650296024%2C%22z%22%3A-3386399.2382792286%7D%2C%22direction%22%3A%7B%22x%22%3A-0.049522995342894845%2C%22y%22%3A0.03484931509869458%2C%22z%22%3A0.9981648151329617%7D%2C%22up%22%3A%7B%22x%22%3A-0.8163071459953779%2C%22y%22%3A0.5744350629673477%2C%22z%22%3A-0.060555774543639126%7D%7D%2C%22homeCamera%22%3A%7B%22west%22%3A144.657%2C%22south%22%3A-29.535%2C%22east%22%3A144.82%2C%22north%22%3A-29.34%7D%2C%22viewerMode%22%3A%223d%22%2C%22showSplitter%22%3Afalse%2C%22splitPosition%22%3A0.4999%2C%22settings%22%3A%7B%22baseMaximumScreenSpaceError%22%3A2%2C%22useNativeResolution%22%3Afalse%2C%22alwaysShowTimeline%22%3Afalse%2C%22baseMapId%22%3A%22basemap-bing-aerial-with-labels%22%2C%22terrainSplitDirection%22%3A0%2C%22depthTestAgainstTerrainEnabled%22%3Afalse%7D%2C%22stories%22%3A%5B%5D%7D%5D%7D
// http://localhost:3002/#start=%7B%22version%22%3A%228.0.0%22%2C%22initSources%22%3A%5B%7B%22stratum%22%3A%22user%22%2C%22models%22%3A%7B%22ArbormetaData%22%3A%7B%22dereferenced%22%3A%7B%22isOpen%22%3Atrue%7D%2C%22knownContainerUniqueIds%22%3A%5B%22%2F%22%5D%2C%22type%22%3A%22arbm-reference%22%7D%2C%22arbm__dungarvan%22%3A%7B%22isOpen%22%3Atrue%2C%22knownContainerUniqueIds%22%3A%5B%22ArbormetaData%22%5D%2C%22type%22%3A%22group%22%7D%2C%22arbm__dungarvan__bound_kml%22%3A%7B%22knownContainerUniqueIds%22%3A%5B%22arbm__dungarvan%22%5D%2C%22type%22%3A%22kml%22%7D%2C%22%2F%22%3A%7B%22type%22%3A%22group%22%7D%7D%2C%22workbench%22%3A%5B%22arbm__dungarvan__bound_kml%22%5D%2C%22timeline%22%3A%5B%5D%2C%22initialCamera%22%3A%7B%22west%22%3A144.51636883300313%2C%22south%22%3A-29.559290464802288%2C%22east%22%3A144.66494026338984%2C%22north%22%3A-29.50883957248143%2C%22position%22%3A%7B%22x%22%3A-4526554.972562336%2C%22y%22%3A3217966.51240187%2C%22z%22%3A-3138080.4519486898%7D%2C%22direction%22%3A%7B%22x%22%3A-0.012602249163339352%2C%22y%22%3A0.008959046346360078%2C%22z%22%3A0.999880452256463%7D%2C%22up%22%3A%7B%22x%22%3A-0.8149358635805853%2C%22y%22%3A0.5793448515821612%2C%22z%22%3A-0.015462250657953203%7D%7D%2C%22homeCamera%22%3A%7B%22west%22%3A144.657%2C%22south%22%3A-29.535%2C%22east%22%3A144.82%2C%22north%22%3A-29.34%7D%2C%22viewerMode%22%3A%223d%22%2C%22showSplitter%22%3Afalse%2C%22splitPosition%22%3A0.4999%2C%22settings%22%3A%7B%22baseMaximumScreenSpaceError%22%3A2%2C%22useNativeResolution%22%3Afalse%2C%22alwaysShowTimeline%22%3Afalse%2C%22baseMapId%22%3A%22basemap-bing-aerial-with-labels%22%2C%22terrainSplitDirection%22%3A0%2C%22depthTestAgainstTerrainEnabled%22%3Afalse%7D%2C%22stories%22%3A%5B%5D%7D%5D%7D
// http://localhost:3002/#start=%7B%22version%22%3A%228.0.0%22%2C%22initSources%22%3A%5B%7B%22stratum%22%3A%22user%22%2C%22models%22%3A%7B%22ArbormetaData%22%3A%7B%22dereferenced%22%3A%7B%22isOpen%22%3Atrue%7D%2C%22knownContainerUniqueIds%22%3A%5B%22%2F%22%5D%2C%22type%22%3A%22arbm-reference%22%7D%2C%22arbm__dungarvan%22%3A%7B%22isOpen%22%3Atrue%2C%22knownContainerUniqueIds%22%3A%5B%22ArbormetaData%22%5D%2C%22type%22%3A%22group%22%7D%2C%22arbm__dungarvan__bound_kml%22%3A%7B%22knownContainerUniqueIds%22%3A%5B%22arbm__dungarvan%22%5D%2C%22type%22%3A%22kml%22%7D%2C%22%2F%22%3A%7B%22type%22%3A%22group%22%7D%7D%2C%22workbench%22%3A%5B%22arbm__dungarvan__bound_kml%22%5D%2C%22timeline%22%3A%5B%5D%2C%22initialCamera%22%3A%7B%22west%22%3A144.51636542589486%2C%22south%22%3A-29.56395103519559%2C%22east%22%3A144.66494367049808%2C%22north%22%3A-29.50417896341235%2C%22position%22%3A%7B%22x%22%3A-4526554.972562336%2C%22y%22%3A3217966.51240187%2C%22z%22%3A-3138080.4519486898%7D%2C%22direction%22%3A%7B%22x%22%3A-0.012602249163339352%2C%22y%22%3A0.008959046346360078%2C%22z%22%3A0.999880452256463%7D%2C%22up%22%3A%7B%22x%22%3A-0.8149358635805853%2C%22y%22%3A0.5793448515821612%2C%22z%22%3A-0.015462250657953203%7D%7D%2C%22homeCamera%22%3A%7B%22west%22%3A144.657%2C%22south%22%3A-29.535%2C%22east%22%3A144.82%2C%22north%22%3A-29.34%7D%2C%22viewerMode%22%3A%223d%22%2C%22showSplitter%22%3Afalse%2C%22splitPosition%22%3A0.5%2C%22settings%22%3A%7B%22baseMaximumScreenSpaceError%22%3A2%2C%22useNativeResolution%22%3Afalse%2C%22alwaysShowTimeline%22%3Afalse%2C%22baseMapId%22%3A%22basemap-bing-aerial-with-labels%22%2C%22terrainSplitDirection%22%3A0%2C%22depthTestAgainstTerrainEnabled%22%3Afalse%7D%2C%22stories%22%3A%5B%7B%22title%22%3A%22xxx%22%2C%22text%22%3A%22%3Cp%3Efdafds%3C%2Fp%3E%22%2C%22id%22%3A%22b1b0d781-423d-41d4-b523-236e34bbefed%22%2C%22shareData%22%3A%7B%22version%22%3A%228.0.0%22%2C%22initSources%22%3A%5B%7B%22stratum%22%3A%22user%22%2C%22models%22%3A%7B%22ArbormetaData%22%3A%7B%22dereferenced%22%3A%7B%22isOpen%22%3Atrue%7D%2C%22knownContainerUniqueIds%22%3A%5B%22%2F%22%5D%2C%22type%22%3A%22arbm-reference%22%7D%2C%22arbm__dungarvan%22%3A%7B%22isOpen%22%3Atrue%2C%22knownContainerUniqueIds%22%3A%5B%22ArbormetaData%22%5D%2C%22type%22%3A%22group%22%7D%2C%22arbm__dungarvan__bound_kml%22%3A%7B%22knownContainerUniqueIds%22%3A%5B%22arbm__dungarvan%22%5D%2C%22type%22%3A%22kml%22%7D%2C%22%2F%22%3A%7B%22type%22%3A%22group%22%7D%7D%2C%22workbench%22%3A%5B%22arbm__dungarvan__bound_kml%22%5D%2C%22timeline%22%3A%5B%5D%2C%22initialCamera%22%3A%7B%22west%22%3A144.51636542589486%2C%22south%22%3A-29.56395103519559%2C%22east%22%3A144.66494367049808%2C%22north%22%3A-29.50417896341235%2C%22position%22%3A%7B%22x%22%3A-4526554.972562336%2C%22y%22%3A3217966.51240187%2C%22z%22%3A-3138080.4519486898%7D%2C%22direction%22%3A%7B%22x%22%3A-0.012602249163339352%2C%22y%22%3A0.008959046346360078%2C%22z%22%3A0.999880452256463%7D%2C%22up%22%3A%7B%22x%22%3A-0.8149358635805853%2C%22y%22%3A0.5793448515821612%2C%22z%22%3A-0.015462250657953203%7D%7D%2C%22homeCamera%22%3A%7B%22west%22%3A144.657%2C%22south%22%3A-29.535%2C%22east%22%3A144.82%2C%22north%22%3A-29.34%7D%2C%22viewerMode%22%3A%223d%22%2C%22showSplitter%22%3Afalse%2C%22splitPosition%22%3A0.5%2C%22settings%22%3A%7B%22baseMaximumScreenSpaceError%22%3A2%2C%22useNativeResolution%22%3Afalse%2C%22alwaysShowTimeline%22%3Afalse%2C%22baseMapId%22%3A%22basemap-bing-aerial-with-labels%22%2C%22terrainSplitDirection%22%3A0%2C%22depthTestAgainstTerrainEnabled%22%3Afalse%7D%7D%5D%7D%7D%5D%7D%5D%7D
// https://arbormeta.earth/#start=%7B%22version%22%3A%228.0.0%22%2C%22initSources%22%3A%5B%7B%22stratum%22%3A%22user%22%2C%22models%22%3A%7B%22ArbormetaData%22%3A%7B%22dereferenced%22%3A%7B%22isOpen%22%3Atrue%7D%2C%22knownContainerUniqueIds%22%3A%5B%22%2F%22%5D%2C%22type%22%3A%22arbm-reference%22%7D%2C%22arbm__bluehills%22%3A%7B%22isOpen%22%3Afalse%2C%22knownContainerUniqueIds%22%3A%5B%22ArbormetaData%22%5D%2C%22type%22%3A%22group%22%7D%2C%22arbm__bluehills__bluehills_180cm_model_2%22%3A%7B%22knownContainerUniqueIds%22%3A%5B%22arbm__bluehills%22%5D%2C%22type%22%3A%22wmts%22%7D%2C%22arbm__bluehills__bluehillsals%22%3A%7B%22knownContainerUniqueIds%22%3A%5B%22arbm__bluehills%22%5D%2C%22type%22%3A%223d-tiles%22%7D%2C%22arbm__gtring%22%3A%7B%22isOpen%22%3Atrue%2C%22knownContainerUniqueIds%22%3A%5B%22ArbormetaData%22%5D%2C%22type%22%3A%22group%22%7D%2C%22%2F%22%3A%7B%22type%22%3A%22group%22%7D%7D%2C%22workbench%22%3A%5B%22arbm__bluehills__bluehillsals%22%2C%22arbm__bluehills__bluehills_180cm_model_2%22%5D%2C%22timeline%22%3A%5B%5D%2C%22initialCamera%22%3A%7B%22west%22%3A144.94163813155313%2C%22south%22%3A-31.3356031678545%2C%22east%22%3A145.3266038903831%2C%22north%22%3A-31.148969431329704%2C%22position%22%3A%7B%22x%22%3A-4477353.374012292%2C%22y%22%3A3119482.636982974%2C%22z%22%3A-3320750.740435295%7D%2C%22direction%22%3A%7B%22x%22%3A-0.03713767604958441%2C%22y%22%3A0.02587473579524727%2C%22z%22%3A0.998975120343426%7D%2C%22up%22%3A%7B%22x%22%3A-0.8196515509743809%2C%22y%22%3A0.5710714719283866%2C%22z%22%3A-0.045262666015581106%7D%7D%2C%22homeCamera%22%3A%7B%22west%22%3A99%2C%22south%22%3A-38.9%2C%22east%22%3A169.5%2C%22north%22%3A-10.7%7D%2C%22viewerMode%22%3A%223d%22%2C%22showSplitter%22%3Afalse%2C%22splitPosition%22%3A0.5%2C%22settings%22%3A%7B%22baseMaximumScreenSpaceError%22%3A2%2C%22useNativeResolution%22%3Afalse%2C%22alwaysShowTimeline%22%3Afalse%2C%22baseMapId%22%3A%22basemap-bing-aerial-with-labels%22%2C%22terrainSplitDirection%22%3A0%2C%22depthTestAgainstTerrainEnabled%22%3Afalse%7D%2C%22stories%22%3A%5B%5D%7D%5D%7D

import i18next from "i18next";

import URI from "urijs";

import queryToObject from "terriajs-cesium/Source/Core/queryToObject";

import Terria from "terriajs/lib/Models/Terria";
import User from "../Additions/LoginManager";
import TerriaError from "terriajs/lib/Core/TerriaError";

const ARBM_ID_PREFIX = "arbm__"; // demo data will be prefixed iwth 'arbmd__'

export class Terria_Arbm extends Terria {
  /** Raise error to user.
   *
   * This accepts same arguments as `TerriaError.from` - but also has:
   *
   * @param forceRaiseToUser - which can be used to force raise the error
   */

  private _loggedInUser: User | null = null;
  private _urlWithoutHash: string;
  private _originalHash: string;
  private _startData: object = {};
  private _firstTimeUrlUpdate: boolean = true;

  constructor() {
    super();

    const uri = new URI(window.location);
    this._originalHash = uri.hash();
    // must do this last, as it modifies `uri`
    this._urlWithoutHash = uri.hash("").toString();
  }

  async userLoggedIn(user: User) {
    this._loggedInUser = user;
    await this._updateUrl();
  }

  async userLoggedOut() {
    this._loggedInUser = null;
    await this._updateUrl();
  }

  private async _updateUrl() {
    // We are doing pretty much the same as what Terria does when the hash of the url changes
    // ( see lib/ViewModels/updateApplicationOnHashChange.ts )
    // But not need to call loadInitSources, because they won't have changed
    try {
      let uri = new URI(this._urlWithoutHash);
      if (this._loggedInUser) {
        uri.hash(this._originalHash);
      }
      (await this.updateApplicationUrl(uri.toString())).throwIfError();
    } catch (e) {
      this.raiseErrorToUser(e);
    }
  }

  private _hasPrivilegedCatalogItems(urlFragment: string): boolean {
    // Note: this is NOT perfect. It will only check whether any catalog items are in
    // - privileged ArborMeta data
    // - demo ArborMeta data
    // - any other data (by definition unprivileged)
    // and this test will simply rely on our naming convention for the ids. This is because we don't really want to
    // attempt and load the data at this early stage.
    // While the latter would be possible, this limitation seems reasonable, because this will work without a hitch as long as users send share links
    // only to people who have (in principle) access to ALL of the referenced ArborMeta data.
    // If a share-link is sent to someone who has can log in, but does not have access to all data, the share-link will maybe work partially,
    // maybe not at all (probably depends on the order of the references), but that seems acceptable for a use-case that is against company policies.

    // Will return true if the start parameters reference at least one privileged catalog item.

    function _testSource(source: any): boolean {
      const models = source["models"];
      const keys = Object.keys(models) as Array<string>;
      for (const key of keys) {
        if (key.startsWith(ARBM_ID_PREFIX)) return true;
      }
      return false;
    }

    function _testSources(sources: Array<any> | null): boolean {
      if (sources) {
        for (const source of sources) {
          if (_testSource(source)) return true;
        }
      }
      return false;
    }

    try {
      if (!urlFragment) return false;
      const hashProperties = queryToObject(urlFragment);
      if (!hashProperties.start) return false;
      const startData = JSON.parse(hashProperties.start);

      // A) test catalog items on the map
      try {
        if (_testSources(startData["initSources"])) return true;
      } catch {}

      // B) test catalog items in stories
      try {
        if (_testSources(startData["stories"]["initSources"])) return true;
      } catch {}
    } catch (e) {
      return false;
    }

    return false; // if we got here, we never found anything that caused us to return true (or false) explicitly
  }

  // Override, which removes the hash from newUrl if
  // a) no user is logged in    AND
  // b) the hash in newUrl references any ArborMeta data which require login (privileged)
  async updateApplicationUrl(newUrl: string) {
    let urlToUse: string = newUrl;
    let uri = new URI(newUrl);
    let fragment: string = uri.fragment();

    // A bit hacky, but can't think of a better way:
    // We only want to display a share-link warning if this is called directly from index.js (ergo: the first time)
    let firstTime = this._firstTimeUrlUpdate;
    this._firstTimeUrlUpdate = false;

    if (fragment) {
      if (
        this._loggedInUser == null &&
        this._hasPrivilegedCatalogItems(fragment)
      ) {
        urlToUse = uri.hash("").toString();
        if (firstTime) {
          this.raiseErrorToUser(
            new TerriaError({
              sender: this,
              title: i18next.t("shareData.loginWarning.title"),
              message: i18next.t("shareData.loginWarning.message")
            })
          );
        }
      }
    }

    return super.updateApplicationUrl(urlToUse);
  }
}
